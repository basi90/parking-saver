{% extends "core/base.html" %}

{% block title %}Parking Saver{% endblock %}

{% block content %}
<h1 class="fw-bold my-3">Parking Saver</h1>

<!-- Save Parking Spot -->
<div class="card p-4">
    <h2 class="h5 fw-semibold mb-3">Save Your Parking Spot</h2>
    <button class="btn btn-primary w-100" onclick="saveLocation()">üìå Save My Location</button>
    <p id="status" class="text-success mt-2"></p>
</div>

<!-- Retrieve Parking Spot -->
<div class="card p-4">
    <h2 class="h5 fw-semibold mb-3">Find Your Car</h2>
    <ul id="locations" class="list-unstyled"></ul>
    <a id="mapLink" href="#" target="_blank" class="btn btn-secondary w-100 hidden mt-3">üìç  Show Location</a>
</div>

<script>
  function saveLocation() {
      const button = document.querySelector("button[onclick='saveLocation()']");

      // Provide immediate feedback
      button.classList.add("loading");
      button.innerHTML = "Saving... ‚è≥";

      if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(function(position) {
              setTimeout(() => {
                  button.classList.remove("loading");
                  button.innerHTML = "üìå Save My Location";
              }, 500);

              const now = new Date();
              const dateFormatted = now.toLocaleDateString('en-US', {
                  day: 'numeric',
                  month: 'long'
              });

              const timeFormatted = now.toLocaleTimeString('en-US', {
                  hour: '2-digit',
                  minute: '2-digit',
                  second: '2-digit'
              });

              let newLocation = {
                  lat: position.coords.latitude.toFixed(6),
                  lon: position.coords.longitude.toFixed(6),
                  date: dateFormatted,
                  time: timeFormatted
              };

              // Save only the latest location
              localStorage.setItem("parking_location", JSON.stringify(newLocation));

              // Vibrate for mobile users
              if (navigator.vibrate) {
                  navigator.vibrate(100);
              }

              // Show a toast notification
              showToast("üöó Parking location saved!");

              showLocation();
          }, function(error) {
              button.classList.remove("loading");
              button.innerHTML = "üìå Save My Location";
              alert("Error getting location: " + error.message);
          });
      } else {
          alert("Geolocation is not supported by this browser.");
      }
  }

  function showLocation() {
      let locationData = localStorage.getItem("parking_location");
      let list = document.getElementById("locations");
      let mapLink = document.getElementById("mapLink");

      if (!locationData) {
          list.innerHTML = "<li class='text-muted'>No location saved.</li>";
          mapLink.classList.add("hidden");
          return;
      }

      let location = JSON.parse(locationData);
      list.innerHTML = `
          <li class="mb-3 text-start">
              <div><strong>Date:</strong> ${location.date}</div>
              <div><strong>Time:</strong> ${location.time}</div>
              <div><strong>Coordinates:</strong> ${location.lat}, ${location.lon}</div>
          </li>
      `;

      let mapsUrl = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream
          ? `maps://maps.apple.com/?q=${location.lat},${location.lon}`
          : `https://www.google.com/maps?q=${location.lat},${location.lon}`;

      mapLink.href = mapsUrl;
      mapLink.classList.remove("hidden");
  }

  function showToast(message) {
      const toast = document.createElement("div");
      toast.className = "toast-message";
      toast.innerText = message;
      document.body.appendChild(toast);
      setTimeout(() => {
          toast.classList.add("fade-out");
          setTimeout(() => toast.remove(), 500);
      }, 2000);
  }

  window.onload = showLocation;
</script>
{% endblock %}
